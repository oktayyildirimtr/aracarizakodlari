---
import type { FaultCodeDetail } from '@lib/db';
import Disclaimer from '@components/Disclaimer.astro';
import LastUpdated from '@components/LastUpdated.astro';
import RelatedCodes from '@components/RelatedCodes.astro';
import { brandModelSlug } from '@lib/slugs';
import { getPartForFaultCode } from '@lib/parts';

interface Props {
  data: FaultCodeDetail;
  brand?: string;
  model?: string;
}
const { data, brand, model } = Astro.props;
const { code, title_tr, description_tr, expert_opinion_tr, drive_safe_tr, updated_at,
  affected_brands, estimated_cost, faq, related_codes, category, description_en } = data;

const partInfo = getPartForFaultCode(code, description_en);
---

<article class="article">
  <div class="wrap">
    <h1 class="article__title">{title_tr}</h1>
    <div class="article__meta">
      {category && <><span class="article__category">Kategori: {category}</span> · </>}
      <LastUpdated date={updated_at} />
    </div>

    {/* 1. Arıza kodu ne anlama gelir? */}
    <section>
      <h2 id="anlam">Arıza kodu ne anlama gelir?</h2>
      {description_en && (
        <p class="article__official-def">
          <strong>Resmi tanım (İngilizce, SAE/ISO uyumlu):</strong> <em>{description_en}</em>
        </p>
      )}
      <div class="article__prose">
        {description_tr.split(/\n\n+/).filter(Boolean).map((p) => (
          <p set:html={p.replace(/\n/g, '<br />')} />
        ))}
      </div>
      {partInfo && (
        <figure class="article__part-figure" aria-label={partInfo.name_tr} data-part-figure>
          <img
            src={partInfo.image_url}
            alt={partInfo.name_tr}
            width="320"
            height="240"
            loading="lazy"
            class="article__part-img"
            onerror="this.closest('[data-part-figure]')?.remove()"
          />
          <figcaption class="article__part-caption">
            <strong>{partInfo.name_tr}</strong>
            {partInfo.attribution && (
              <span class="article__part-attribution"> · {partInfo.attribution}</span>
            )}
          </figcaption>
        </figure>
      )}
    </section>

    {/* 2. Hangi araçlarda görülür? */}
    <section>
      <h2 id="araclar">Hangi araçlarda görülür?</h2>
      <p>
        {brand && model
          ? `${brand} ${model} bu kodda sık geçen modellerden. Aşağıda ${code} için yaygın marka ve model örnekleri var.`
          : `${code} aşağıdaki marka ve modellerde sık görülür.`
        }
      </p>
      <ul>
        {affected_brands.map((b) => (
          <li>
            <a href={brandModelSlug(b.brand, b.model, code)}>{b.brand} {b.model}</a>
          </li>
        ))}
      </ul>
    </section>

    {/* 3. Bu şekilde araç kullanılır mı? */}
    <section>
      <h2 id="kullanim">Bu şekilde araç kullanılır mı?</h2>
      <div class="article__prose">
        {drive_safe_tr.split(/\n\n+/).filter(Boolean).map((p) => (
          <p set:html={p.replace(/\n/g, '<br />')} />
        ))}
      </div>
    </section>

    {/* 4. Türkiye için tahmini onarım maliyeti */}
    <section>
      <h2 id="maliyet">Türkiye için tahmini onarım maliyeti</h2>
      {estimated_cost ? (
        <p>
          Tahmini maliyet aralığı (işçilik ve parça dahil): <strong>{estimated_cost.min_try.toLocaleString('tr-TR')} – {estimated_cost.max_try.toLocaleString('tr-TR')} TL</strong>.
          {estimated_cost.notes_tr && ` ${estimated_cost.notes_tr}`}
        </p>
      ) : (
        <p>Bu kod için genel bir maliyet aralığı verilememektedir; sebep ve araca göre değişir. Bir serviste teşhis yaptırmanız önerilir.</p>
      )}
    </section>

    {/* 5. Uzman görüşü */}
    <section>
      <h2 id="uzman">Uzman görüşü</h2>
      <div class="article__prose">
        {expert_opinion_tr.split(/\n\n+/).filter(Boolean).map((p) => (
          <p set:html={p.replace(/\n/g, '<br />')} />
        ))}
      </div>
    </section>

    <Disclaimer />

    {/* 6. SSS */}
    {faq.length > 0 && (
      <section>
        <h2 id="sss">Sık sorulan sorular</h2>
        <dl class="faq-list">
          {faq.map((item) => (
            <>
              <dt>{item.question_tr}</dt>
              <dd>{item.answer_tr}</dd>
            </>
          ))}
        </dl>
      </section>
    )}

    {/* 7. İlgili arıza kodları */}
    <RelatedCodes codes={related_codes} />
  </div>
</article>
