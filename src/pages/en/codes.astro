---
import Layout from '@layouts/Layout.astro';
import { getIndexedFaultCodes } from '@lib/db';
import { faultCodePath, getCategoryDisplay } from '@lib/i18n';
import { UI, ROUTES, getCanonicalUrl } from '@lib/i18n';

const lang = 'en';
const ui = UI[lang];
const codes = getIndexedFaultCodes();
const categorySet = new Map<string, string>();
for (const c of codes) {
  if (c.category && !categorySet.has(c.category)) {
    categorySet.set(c.category, getCategoryDisplay(c.category, lang)!);
  }
}
const categories = [...categorySet.entries()].sort((a, b) => a[1].localeCompare(b[1]));

const breadcrumbSchemaData = {
  '@context': 'https://schema.org',
  '@type': 'BreadcrumbList',
  itemListElement: [
    { '@type': 'ListItem', position: 1, name: 'Home', item: getCanonicalUrl('en') },
    { '@type': 'ListItem', position: 2, name: 'All error codes', item: getCanonicalUrl('en/codes') },
  ],
};
---

<Layout
  lang={lang}
  title={ui.codes.title}
  description="OBD-II error codes list. Search P0xxx codes, filter by category. Click for definitions and repair cost estimates."
  currentPath="en/codes"
  breadcrumbSchema={breadcrumbSchemaData}
>
  <div class="wrap">
    <article class="kodlar-page">
      <h1 class="kodlar-page__title">{ui.codes.title}</h1>
      <p class="kodlar-page__lead">{ui.codes.lead}</p>
      <form class="kodlar-filters" id="kodlar-filters" role="search" aria-label="Filter code list">
        <div class="kodlar-filters__group">
          <label for="kodlar-search">{ui.codes.searchLabel}</label>
          <input type="search" id="kodlar-search" name="q" placeholder="e.g. P0171, MAFâ€¦" autocomplete="off" />
        </div>
        <div class="kodlar-filters__group">
          <label for="kodlar-category">{ui.codes.categoryLabel}</label>
          <select id="kodlar-category" name="cat">
            <option value="">{ui.codes.all}</option>
            {categories.map(([trCat, enCat]) => (
              <option value={trCat}>{enCat}</option>
            ))}
          </select>
        </div>
      </form>
      <p class="kodlar-page__count" id="kodlar-count">{codes.length} {ui.codes.count}</p>
      <ul class="kodlar-list" id="kodlar-list">
        {codes.map((fc) => (
          <li class="kodlar-list__item" data-code={fc.code} data-category={fc.category ?? ''} data-title={(fc.title_tr + ' ' + (fc.description_en || '')).toLowerCase()}>
            <a href={`/${faultCodePath(fc.code, lang)}`}>
              <span class="kodlar-list__code">{fc.code}</span>
              {fc.category && <span class="kodlar-list__cat">{getCategoryDisplay(fc.category, lang)}</span>}
            </a>
          </li>
        ))}
      </ul>
    </article>
  </div>
</Layout>

<script>
  (function () {
    const form = document.getElementById('kodlar-filters');
    const search = document.getElementById('kodlar-search');
    const category = document.getElementById('kodlar-category');
    const list = document.getElementById('kodlar-list');
    const countEl = document.getElementById('kodlar-count');
    const items = list ? list.querySelectorAll('.kodlar-list__item') : [];
    const params = new URLSearchParams(location.search);
    const q = params.get('q') || '';
    const cat = params.get('cat') || '';
    if (q) search.value = q;
    if (cat) category.value = cat;
    function filter() {
      const s = (search?.value || '').trim().toLowerCase();
      const c = (category?.value || '').trim();
      let visible = 0;
      items.forEach((el) => {
        const matchSearch = !s || el.dataset.code.toLowerCase().includes(s) || (el.dataset.title || '').includes(s);
        const matchCat = !c || (el.dataset.category || '') === c;
        el.hidden = !(matchSearch && matchCat);
        if (matchSearch && matchCat) visible++;
      });
      if (countEl) countEl.textContent = visible + ' codes listed.';
    }
    form?.addEventListener('input', filter);
    form?.addEventListener('change', filter);
    filter();
  })();
</script>
